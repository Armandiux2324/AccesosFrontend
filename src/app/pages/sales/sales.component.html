<div class="d-flex">
  <main class="flex-grow-1 p-4" style="margin-left: 4.5rem;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Gestión de visitas</h1>
      <button *ngIf="role == 'Taquilla'" class="btn btn-outline-secondary" (click)="openAddModal()">
        <i class="bi bi-person-plus-fill me-1"></i>
        Registrar visita
      </button>
    </div>

    <div class="mb-2">
      <label for="searchDate" class="form-label">Buscar visitas por fecha:</label>
    </div>
    <div class="input-group mb-4">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input
        type="date"
        class="form-control"
        placeholder="Buscar por fecha..."
        [(ngModel)]="searchDateText"
        (ngModelChange)="searchByDate()"
      />
      <button
        *ngIf="searchDateText"
        class="btn btn-outline-secondary"
        (click)="resetSearch()"
      >
        Cancelar
      </button>
    </div>

    <div class="visits-list">
      <div
        *ngFor="let v of visits"
        class="card visit-card mb-3"
      >
        <div class="card-body d-flex align-items-center">
          <i class="bi bi-calendar-check-fill visit-icon me-4"></i>
          <div class="flex-grow-1">
            <h5 class="mb-1">Fecha de visita: {{ v.created_at | date:'dd/MM/yyyy':'UTC' }}</h5>
            <p class="mb-0 text-muted">Contacto: {{ v.contact }}</p>
            <p *ngIf="v.duration_minutes > 0" class="mb-0 text-muted">Duración de la visita: {{ v.duration_minutes | duration }}</p>
            <p class="mb-0 text-muted">Municipio de procedencia: {{ v.township }}</p>
            <p *ngIf="v.school" class="mb-0 text-muted">Escuela de procedencia: {{ v.school }}</p>
            <small *ngIf="v.ticket.status == 'Activo'" class="badge bg-success">Activa</small>
            <small *ngIf="v.ticket.status == 'Inactivo'" class="badge bg-secondary">Inactiva</small>
            <small *ngIf="v.ticket.status == 'Sin iniciar'" class="badge bg-warning">Sin iniciar</small>
          </div>
          <div class="actions">
            <button *ngIf="role == 'Taquilla'" class="btn btn-sm btn-outline-warning me-2 text-dark" (click)="onChangeStatus(v)">
              <i class="bi bi-pencil-square me-2"></i>
              Cambiar estado
            </button>
            <button class="btn btn-sm btn-outline-success me-2" (click)="promptViewPayment(v.id)">
              <i class="bi bi-currency-dollar"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary me-2" (click)="promptViewTicket(v.id)">
              <i class="bi bi-ticket-detailed"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger me-2" (click)="promptDeleteVisit(v.id)">
              <i class="bi bi-trash-fill"></i>
            </button>
          </div>
        </div>
      </div>
      <p *ngIf="!visits.length" class="text-center text-muted">No hay visitas.</p>

      <nav *ngIf="totalPages > 0" aria-label="Paginación visitas">
        <ul class="pagination justify-content-center">
          <li
            class="page-item"
            [class.disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)"
          >
            <a class="page-link">Anterior</a>
          </li>

          <li
            *ngFor="let p of pagesArray"
            class="page-item"
            [class.active]="p === currentPage"
            (click)="goToPage(p)"
          >
            <a class="page-link">{{ p }}</a>
          </li>

          <li
            class="page-item"
            [class.disabled]="currentPage == totalPages"
            (click)="goToPage(currentPage + 1)"
          >
            <a class="page-link">Siguiente</a>
          </li>
        </ul>
      </nav>
    </div>
  </main>
</div>

<div
  aria-live="polite"
  aria-atomic="true"
  class="position-fixed top-0 start-50 translate-middle-x p-3"
  style="z-index: 1055; width: 100%; max-width: 400px;"
>
  <div
    *ngIf="showSuccessToast"
    class="toast show align-items-center text-bg-success border-0 mx-auto"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="d-flex">
      <div class="toast-body">
        {{ toastMessage }}
      </div>
    </div>
  </div>

  <div
    *ngIf="showErrorToast"
    class="toast show align-items-center text-bg-danger border-0 mx-auto mt-2"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="d-flex">
      <div class="toast-body">
        {{ toastMessage }}
      </div>
    </div>
  </div>
</div>

<!-- Modal de eliminar visita -->
<div
  *ngIf="showDeleteModal"
  class="modal fade show"
  tabindex="-1"
  style="display: block; background: rgba(0,0,0,0.5);"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar eliminación</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="cancelDelete()"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar esta visita?</p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cancelDelete()">
          Cancelar
        </button>
        <button class="btn btn-danger" (click)="deleteVisit()">
          Eliminar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal de ticket -->
<div
  *ngIf="showTicketModal"
  class="modal fade show"
  tabindex="-1"
  style="display: block; background: rgba(0,0,0,0.5);"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content ticket-modal">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Ticket de venta</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeTicketModal()"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body ticket">
        <div class="ticket-header text-center">
          <h4 class="mb-1">Museo ZigZag</h4>
          <small>Gracias por tu visita</small>
        </div>
        <hr class="ticket-separator" />

        <div class="ticket-body">
          <div class="qr-container text-center mb-3">
            <img
              [src]="'http://localhost:3000/qr/' + visitInfo.ticket.qr"
              alt="QR Code"
              class="qr-img"
            />
          </div>
          <div class="ticket-info mb-2">
            <p *ngIf="visitInfo.datetime_begin"><strong>Inicio:</strong> {{ visitInfo.datetime_begin | date:'short': 'UTC' }}</p>
            <p *ngIf="visitInfo.datetime_end"><strong>Fin:</strong> {{ visitInfo.datetime_end | date:'short': 'UTC' }}</p>
          </div>
          <div class="ticket-counts mb-2">
            <p *ngIf="adultsCount">Adultos: {{ adultsCount }}</p>
            <p *ngIf="childrenCount">Niños:   {{ childrenCount }}</p>
            <p *ngIf="seniorsCount">Adultos mayores: {{ seniorsCount }}</p>
            <p *ngIf="disabledCount">Discapacitados: {{ disabledCount }}</p>
            <p>Desc. acompaña.: {{ visitInfo.ticket.discount }}</p>
          </div>
          <hr class="ticket-separator" />
          <div class="ticket-total text-end">
            <h5>Total: {{ visitInfo.ticket.payment.total }}</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de pago -->
<div
  *ngIf="showPaymentModal"
  class="modal fade show"
  tabindex="-1"
  style="display: block; background: rgba(0,0,0,0.5);"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content ticket-modal">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Pago de visita</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closePaymentModal()"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body ticket">
        <div class="ticket-header text-center">
          <h4 class="mb-1">Información de pago</h4>
        </div>
        <hr class="ticket-separator" />

        <div class="ticket-body">
          <div class="ticket-info mb-2">
            <p *ngIf="visitInfo.ticket.payment.payment_type == 'Tarjeta'"><strong>Referencia de pago:</strong> {{ visitInfo.ticket.payment.reference }}</p>
            <p><strong>Tipo de pago: </strong>{{visitInfo.ticket.payment.payment_type}} </p>
            <p><strong>Fecha y hora de pago:</strong>    {{ visitInfo.ticket.payment.payment_date | date:'short': 'UTC' }}</p>
            <h5><strong>Total:</strong> ${{ visitInfo.ticket.payment.total }}</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de registro de visitas -->
<div
  *ngIf="showAddModal"
  class="modal fade show"
  tabindex="-1"
  style="display: block; background: rgba(0,0,0,0.5);"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header text-white" style="background: #343a40;">
        <h5 class="modal-title">Registrar visita</h5>
        <button type="button" class="btn-close btn-close-white"
                (click)="closeAddModal()"></button>
      </div>

      <div class="modal-body">
        <form #formAdd="ngForm">

          <div class="mb-3">
            <label for="contact" class="form-label">Contacto</label>
            <input
              id="contact"
              type="text"
              class="form-control"
              name="contact"
              placeholder="Email o teléfono"
              [(ngModel)]="visitToAdd.contact"
              required
            />
          </div>

          <div class="mb-3">
            <label for="township" class="form-label">Municipio de origen</label>
              <mat-form-field class="example-full-width mb-0">
              <mat-label>Municipio</mat-label>
              <input type="text"
                    placeholder="Seleccione un municipio"
                    aria-label="Number"
                    matInput
                    [(ngModel)]="visitToAdd.township"
                    [formControl]="townshipCtrl"
                    [matAutocomplete]="auto">
              <mat-autocomplete #auto="matAutocomplete" class="autocomplete-panel-over">
              <mat-option
                *ngFor="let t of filteredTownships | async"
                [value]="t"
              >
                {{ t }}
              </mat-option>
            </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="mb-3">
            <label for="school" class="form-label">Escuela (opcional)</label>
            <input
              id="school"
              type="text"
              class="form-control"
              name="school"
              placeholder="Nombre de la escuela"
              [(ngModel)]="visitToAdd.school"
            />
          </div>

          <div class="mb-3">
            <label for="payment_type" class="form-label">Método de pago</label>
            <select name="payment_type" id="payment_type" class="form-control" [(ngModel)]="paymentData.payment_type">
              <option value="Tarjeta" selected>Tarjeta</option>
              <option value="Efectivo">Efectivo</option>
            </select>
          </div>

          <label class="form-label">Agregar visitantes</label>

          <ng-form #visitorForm="ngForm">
            <div class="row g-2 align-items-end">
              <div class="col">
                <label class="form-label">Género</label>
                <select
                  class="form-select"
                  name="gender"
                  [(ngModel)]="visitorInfo.gender"
                  required
                >
                  <option value="" disabled>Selecciona género</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>

              <div class="col">
                <label class="form-label">Tipo de visitante</label>
                <select
                  class="form-select"
                  name="price_id"
                  [(ngModel)]="visitorInfo.price_id"
                  required
                >
                  <option value="" disabled>Selecciona tipo</option>
                  <option *ngFor="let p of prices" [value]="p.id">
                    {{ p.type }}
                  </option>
                </select>
              </div>

              <div class="col-2">
                <label class="form-label">Cantidad</label>
                <input
                  type="number"
                  class="form-control"
                  name="quantity"
                  [(ngModel)]="quantity"
                  min="1"
                  required
                />
              </div>

              <div class="col-auto">
                <button
                  type="button"
                  class="btn btn-success"
                  (click)="addVisitor()"
                  [disabled]="visitorForm.invalid"
                >
                  Agregar
                </button>
              </div>
            </div>
          </ng-form>
          <div class="mt-3" *ngIf="visitors.length">
            <h6>Visitantes agregados:</h6>
            <ul class="list-group">
              <li
                *ngFor="let v of visitors; let i = index"
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <span>
                  {{ getPriceType(v.price_id) }} {{ v.gender }}
                </span>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  (click)="removeVisitor(i)"
                >
                  <i class="bi bi-trash-fill"></i>
                </button>
              </li>
            </ul>
          </div>

          <div class="mb-3">
            <label for="discount" class="form-label">Descuento de acompañantes</label>
            <select name="discount" id="discount" class="form-control" [(ngModel)]="discount" (change)="onDiscountChange()">
              <option value="Sí" selected>Sí</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>Total:</strong></label>
            <div class="fs-4">
              {{ total | currency }}
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeAddModal()">Cancelar</button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="formAdd.invalid || !visitors.length"
              (click)="addVisit()"
            >
              Registrar visita
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de cambiar estado -->
<div
  *ngIf="showStatusModal"
  class="modal fade show"
  tabindex="-1"
  style="display: block; background: rgba(0,0,0,0.5);"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header text-white" style="background: #ffc107;">
        <h5 class="modal-title">Cambiar estado de visita</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeStatusModal()"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="updateStatus()" #formPass="ngForm">

          <div class="mb-3">
            <label class="form-label">Selecciona el estado</label>
            <select
              class="form-select"
              [(ngModel)]="status"
              name="status"
              required
              #statusSelect="ngModel"
            >
              <option value="" disabled selected>Selecciona un estado</option>
              <option value="Activo">Activo</option>
              <option value="Inactivo">Finalizado</option>
              <option value="Sin iniciar">Sin iniciar</option>
            </select>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeStatusModal()">
          Cancelar
        </button>
        <button
          class="btn btn-warning"
          [disabled]="formPass.invalid"
          (click)="updateStatus()"
        >
          Cambiar estado
        </button>
      </div>

    </div>
  </div>
</div>



